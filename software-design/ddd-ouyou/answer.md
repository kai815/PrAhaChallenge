# 課題１

## ログインなどのアクセス制御ロジックについて

### オニオンアーキテクチャのどの層に書くのがいいか

ログインしてるかを確認するのに、外部サービスに接続するところはインフラ層に書いたほうがいいと思う。
認証基盤がFirebaseからAuth0に変わる、もしくは自社の認証基盤になるなどがあった時に影響を抑えることができるので。

認証・認可の結果を用いて制御をどこに書くかは結構悩ましい。
ドメイン層に書くのはアプリケーションが存在しなくても現実世界で存在するルールというのがよく言われているが、
どちらとも捉えられる。
例えば、学校の中間・期末テストを作成するアプリがあった時に、生徒が中間・期末テストを作成できないというのは現実でもそうだし、アプリ上もそう。
（とはいえ、現実世界ではそもそも生徒がテストを作成しようとするシーンがないかもしれない？）

アクセス制御はユースケースに応じて変わることが多いようにも感じていて、
（先ほどのテスト作成の例だと教育実習生は元々作成できないけど、ユースケースが変わるor新しいニーズが出てきて、
やっぱり作成できるようにしたいなど）
そう考えるとユースケースかなぁと思ったりしている。
またデータの項目ごとにアクセス制御はあり得るので。そう考えると、よりユースケースな感じがする。

#### 参考
https://zenn.dev/praha/articles/5c05ab671fb7ab

https://github.com/little-hands/ddd-q-and-a/issues/121

## 複数の集約をまたいで整合性を担保したい時

### どのように実装すれば、複数集約の整合性が担保されるか？

1. ユースケース層で複数集約を更新するように実装する
2. ドメインサービスを使い複数集約を更新するように実装する
3. ドメインイベントを使い、更新されたら更新されるようにする

### また複数の集約で整合性を担保するというのはそもそもどうなのか？

トランザクションまでは貼らなくていいかなぁと。結果整合性でいいかな。
強い整合性が本当に必要なら、集約同じにするのがいいかと。

### 参考

https://little-hands.hatenablog.com/entry/2021/03/08/aggregation

https://blog.j5ik2o.me/entry/2021/03/09/231332
https://blog.j5ik2o.me/entry/2021/03/22/102520

https://hachibeechan.hateblo.jp/entry/domain-driven-deskwork

## Userエンティティに「name」や「avatarImage」など、マイページで表示される情報がプロパティとして定義されている状態の時について

### User エンティティに`isLoggedIn`,`emailAddress`,`firebaseUserId`などの認証に関わる属性を増やすのはどうか？

このUserクラスの責務をどこまでにするかということだが、認証用にのみ必要な情報と
マイページなどのアプリケーションで使うUserは分けたほうがいいと考えている。
責務が広がりすぎる可能性があるのが1つ。
また、`firebaseUserId`など認証に必要な情報が認証基盤(外部認証サービス)の変更によって変わった場合に、
ドメインのビジネスロジックとは関係ないところで変更が生じる可能性があるのがもう1つの理由。
また、セキュリティ事故防止のためにも分けたほうがいい。
### 参考

https://github.com/little-hands/ddd-q-and-a/issues/173

https://www.infoq.com/jp/articles/ddd-contextmapping_jp/

## 文字数上限のバリデーションについて
以下のようなコードが提出された

https://gist.github.com/Dowanna/6519efa3f5cd3b40995e1e7eda44853a
### 文字数の上限を超えた際にエラーをthrowすることに関して、どのような問題が起き得るか?

1. ヒント1.：エラーをthrowする以外に、どのような設計パターンが考えられるか？例えばGo言語であれば、戻り値の第2引数にエラー型のオブジェクトを返すようにすることがよくある

2. ヒント2：関数型プログラミングの世界には「モナド」と呼ばれる概念があり、これを活用する方法はあるか？

問題としては、以下の2つ。
1. throwされただけだと、呼び出しもとでどんなエラーか判断しずらい。
2. 呼び出しもとで特に対処せずにスルーすることもできる。（言語によりそう）


[この記事](https://qiita.com/shimopino/items/d194957599dd45e91a5f)のようにresult型を使う設計方法もある。


### 参考
https://github.com/little-hands/ddd-q-and-a/issues/763

https://zenn.dev/hanpenman/articles/c59d908e4ad028

https://qiita.com/shimopino/items/d194957599dd45e91a5f

https://qiita.com/tomokiyao/items/3860c8e3cd3f21126b21